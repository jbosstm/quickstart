## Build the demo

```bash
mvn clean package
```

## Trip Demo

    start LRA 1
        Book hotel
        start LRA 2
            start LRA 3
                Book flight option 1
            start LRA 4
                Book flight option 2
    cancel LRA 3
    close LRA 1 (results in the hotel and flight option 2 being confirmed)

### Make sure the LRA coordinator and various services are running 

For simplicity the trip, hotel and flight services all run in the same JVM and all listen on the same http port. However, inter-service requests are still performed using http so running each service in a separate JVM will also work.

Start the coordinator:

```bash
java -jar $NARAYANA_INSTALL_LOCATION/rts/lra/lra-coordinator-swarm.jar
```

Start the trip, hotel and flight services:

```bash
java -jar target/lra-test-swarm.jar -Dswarm.http.port=8081 -Dlra.http.port=8080
```

The system property *lra.http.port* specifies the port on which the LRA coordinator is listening.

(If you want to enable source level debugging use -Dswarm.debug.port=<port>).

### Update a trip booking

Make a provisional booking and then amend it before confirming the booking. Apart from using
Jackson for parsing Json the client (TripClient) only uses Java SE APIs.

```bash
java -cp target/classes:target/lra-test/WEB-INF/lib/* -Dlra.http.port=8080 -Dservice.http.port=8081 TripClient
```

The system properties *lra.http.port* and *service.http.port* specify the ports on which the LRA
coordinator and example service are is listening, respectively.

### One shot bookings using curl:

```bash
curl -X POST  "http://localhost:8081/trip/book?hotelName=Rex"
curl -X POST  "http://localhost:8081/trip/book?flightNumber=BA123"
```

## Running the demo on Minishift

You will need to have installed Minishift and have the tools in your command line.

We provisioned Minishift as:
```bash
minishift start
```

Once you have the Minishift environment available the following steps (assuming you have the Narayana distribution unzipped to NARAYANA_INSTALL_LOCATION
```bash
oc new-project lra-minishift

# Deploy the LRA coordinator
cd lra-coordinator && mkdir target
oc new-build --binary --name=lra-coordinator -l app=lra-coordinator
cp $NARAYANA_INSTALL_LOCATION/rts/lra/lra-coordinator-swarm.jar target/lra-coordinator-swarm.jar
oc start-build lra-coordinator --from-dir=. --follow
oc new-app lra-coordinator -l app=lra-coordinator
oc expose service lra-coordinator
cd ..

# Deploy the Trip controller
oc new-build --binary --name=trip-service -l app=trip-service
mvn clean package
oc start-build trip-service --from-dir=. --follow
oc new-app trip-service -l app=trip-service
oc expose service trip-service
```

You can then run the client as above:

```bash
java -cp "target/classes;target/lra-test/WEB-INF/lib/*" -Dservice.http.host="trip-service-lra-minishift.`minishift ip`.nip.io" -Dservice.http.port=80 TripClient
```

To check the logs you can look at:
```bash
oc logs -f `oc get pods | grep ^trip-service | grep Running | awk '{ print $1 }'`
oc logs -f `oc get pods | grep ^lra-coordinator | grep Running | awk '{ print $1 }'`
```